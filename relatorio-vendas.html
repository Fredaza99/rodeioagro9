<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
  <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-solid-straight/css/uicons-solid-straight.css'>
  <title>Relatório de Vendas - Rodeio Agronegócio</title>
  <style>
    .sales-report-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .report-header {
      background: linear-gradient(135deg, #2c5530, #4a7c59);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .report-header h1 {
      margin: 0;
      font-size: 2.5em;
      font-weight: 300;
    }
    
    .filters-section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .filters-row {
      display: flex;
      gap: 20px;
      align-items: end;
      flex-wrap: wrap;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c5530;
    }
    
    .filter-group input, .filter-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .filter-group input:focus, .filter-group select:focus {
      outline: none;
      border-color: #4a7c59;
    }
    
    .filter-btn {
      background: #4a7c59;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    .filter-btn:hover {
      background: #2c5530;
    }
    
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center;
      border-left: 5px solid #4a7c59;
    }
    
    .summary-card h3 {
      margin: 0 0 10px 0;
      color: #2c5530;
      font-size: 1.1em;
    }
    
    .summary-card .value {
      font-size: 2em;
      font-weight: bold;
      color: #4a7c59;
      margin: 0;
    }
    
    .receipts-table-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .receipts-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .receipts-table th {
      background: #2c5530;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 16px;
    }
    
    .receipts-table td {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 15px;
    }
    
    .receipts-table tr:hover {
      background: #f8f9fa;
    }
    
    .receipt-value {
      font-weight: bold;
      color: #4a7c59;
    }
    
    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #4a7c59;
    }
    
    .export-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }
    
    .export-btn:hover {
      background: #218838;
    }
    
    .analysis-tabs {
      display: flex;
      margin-bottom: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .tab-button {
      flex: 1;
      padding: 15px 20px;
      background: #f8f9fa;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      border-right: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .tab-button .material-icons {
      font-size: 20px;
    }
    
    .tab-button:last-child {
      border-right: none;
    }
    
    .tab-button.active {
      background: #4a7c59;
      color: white;
    }
    
    .tab-button:hover:not(.active) {
      background: #e9ecef;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .product-analysis-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .product-summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding: 20px;
      background: #f8f9fa;
    }
    
    .product-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border-left: 4px solid #4a7c59;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .product-card h4 {
      margin: 0 0 10px 0;
      color: #2c5530;
      font-size: 0.9em;
      text-transform: uppercase;
    }
    
    .product-card .product-name {
      font-size: 1.1em;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .product-card .quantity {
      font-size: 1.5em;
      font-weight: bold;
      color: #4a7c59;
      margin: 5px 0;
    }
    
    .product-card .value {
      font-size: 1.3em;
      font-weight: bold;
      color: #28a745;
    }
    
    .sort-controls {
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .sort-controls label {
      margin-right: 10px;
      font-weight: 600;
      color: #2c5530;
    }
    
    .sort-controls select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 15px;
    }
    
    .product-details-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .product-details-table th {
      background: #2c5530;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 16px;
    }
    
    .product-details-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 15px;
    }
    
    .product-details-table tr:hover {
      background: #f8f9fa;
    }
    
    .product-row {
      background: #fff;
    }
    
    .product-row.expanded {
      background: #f8f9fa;
    }
    
    .expand-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: #4a7c59;
      font-weight: bold;
    }
    
    .sales-details {
      display: none;
    }
    
    .sales-details.show {
      display: table-row;
    }
    
    .sales-details td {
      background: #f8f9fa;
      padding-left: 40px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCAM6g3AXwsKoQOsBRYlNs5f6E7dv3H0As",
      authDomain: "rodeioagro-fee43.firebaseapp.com",
      projectId: "rodeioagro-fee43",
      storageBucket: "rodeioagro-fee43.appspot.com",
      messagingSenderId: "981787707311",
      appId: "1:981787707311:web:e5a8749b6928969ff1d15a",
      measurementId: "G-FM9TP3QF6N"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Redirect to login if the user is not authenticated
    if (!sessionStorage.getItem('loggedIn')) {
      window.location.href = 'login.html';
    }

    let receiptsData = [];
    let productAnalysisData = [];

    document.addEventListener("DOMContentLoaded", () => {
      loadReceiptsData();
      
      // Event listeners
      document.getElementById("filterBtn").addEventListener("click", applyFilters);
      document.getElementById("exportBtn").addEventListener("click", exportToPDF);
      document.getElementById("exportProductBtn").addEventListener("click", exportProductAnalysisToPDF);
      
      // Tab switching
      document.getElementById("receiptsTab").addEventListener("click", () => switchTab('receipts'));
      document.getElementById("productsTab").addEventListener("click", () => switchTab('products'));
      
      // Product analysis controls
      document.getElementById("sortBy").addEventListener("change", updateProductAnalysis);
      
      // Auto-apply filters when date changes
      document.getElementById("startDate").addEventListener("change", applyFilters);
      document.getElementById("endDate").addEventListener("change", applyFilters);
    });

    function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      if (tab === 'receipts') {
        document.getElementById('receiptsTab').classList.add('active');
        document.getElementById('receiptsContent').classList.add('active');
      } else if (tab === 'products') {
        document.getElementById('productsTab').classList.add('active');
        document.getElementById('productsContent').classList.add('active');
        updateProductAnalysis();
      }
    }

    async function loadReceiptsData() {
      try {
        document.getElementById("loadingMessage").style.display = "block";
        
        // Buscar todos os recibos da coleção 'receipts'
        const receiptsCollection = collection(db, 'receipts');
        const querySnapshot = await getDocs(receiptsCollection);
        
        receiptsData = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          receiptsData.push({
            id: doc.id,
            ...data
          });
        });
        
        // Ordenar por data (mais recente primeiro)
        receiptsData.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        document.getElementById("loadingMessage").style.display = "none";
        applyFilters();
        generateProductAnalysis();
        
      } catch (error) {
        console.error("Erro ao carregar dados dos recibos:", error);
        document.getElementById("loadingMessage").innerHTML = "Erro ao carregar dados";
      }
    }

    function generateProductAnalysis() {
      const productMap = new Map();
      
      receiptsData.forEach(receipt => {
        const productName = receipt.productName;
        const quantity = receipt.exitQuantity || 0;
        const totalValue = receipt.totalValue || 0;
        const unitValue = receipt.unitValue || 0;
        
        if (productMap.has(productName)) {
          const existing = productMap.get(productName);
          existing.totalQuantity += quantity;
          existing.totalValue += totalValue;
          existing.salesCount += 1;
          existing.sales.push({
            date: receipt.date,
            buyer: receipt.soldTo,
            quantity: quantity,
            unitValue: unitValue,
            totalValue: totalValue
          });
        } else {
          productMap.set(productName, {
            productName: productName,
            totalQuantity: quantity,
            totalValue: totalValue,
            salesCount: 1,
            averageUnitValue: unitValue,
            sales: [{
              date: receipt.date,
              buyer: receipt.soldTo,
              quantity: quantity,
              unitValue: unitValue,
              totalValue: totalValue
            }]
          });
        }
      });
      
      // Calculate average unit values
      productMap.forEach(product => {
        if (product.totalQuantity > 0) {
          product.averageUnitValue = product.totalValue / product.totalQuantity;
        }
      });
      
      productAnalysisData = Array.from(productMap.values());
    }

    function updateProductAnalysis() {
      const sortBy = document.getElementById("sortBy").value;
      
      // Apply current filters
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const buyerFilter = document.getElementById("buyerFilter").value.toLowerCase();
      
      let filteredReceipts = receiptsData;
      
      if (startDate) {
        filteredReceipts = filteredReceipts.filter(receipt => receipt.date >= startDate);
      }
      
      if (endDate) {
        filteredReceipts = filteredReceipts.filter(receipt => receipt.date <= endDate);
      }
      
      if (buyerFilter) {
        filteredReceipts = filteredReceipts.filter(receipt => 
          receipt.soldTo.toLowerCase().includes(buyerFilter)
        );
      }
      
      // Generate analysis from filtered data
      const productMap = new Map();
      
      filteredReceipts.forEach(receipt => {
        const productName = receipt.productName;
        const quantity = receipt.exitQuantity || 0;
        const totalValue = receipt.totalValue || 0;
        const unitValue = receipt.unitValue || 0;
        
        if (productMap.has(productName)) {
          const existing = productMap.get(productName);
          existing.totalQuantity += quantity;
          existing.totalValue += totalValue;
          existing.salesCount += 1;
          existing.sales.push({
            date: receipt.date,
            buyer: receipt.soldTo,
            quantity: quantity,
            unitValue: unitValue,
            totalValue: totalValue
          });
        } else {
          productMap.set(productName, {
            productName: productName,
            totalQuantity: quantity,
            totalValue: totalValue,
            salesCount: 1,
            sales: [{
              date: receipt.date,
              buyer: receipt.soldTo,
              quantity: quantity,
              unitValue: unitValue,
              totalValue: totalValue
            }]
          });
        }
      });
      
      // Calculate average unit values
      productMap.forEach(product => {
        if (product.totalQuantity > 0) {
          product.averageUnitValue = product.totalValue / product.totalQuantity;
        }
      });
      
      let sortedProducts = Array.from(productMap.values());
      
      // Sort products
      switch (sortBy) {
        case 'quantity':
          sortedProducts.sort((a, b) => b.totalQuantity - a.totalQuantity);
          break;
        case 'value':
          sortedProducts.sort((a, b) => b.totalValue - a.totalValue);
          break;
        case 'name':
          sortedProducts.sort((a, b) => a.productName.localeCompare(b.productName));
          break;
        case 'sales':
          sortedProducts.sort((a, b) => b.salesCount - a.salesCount);
          break;
      }
      
      renderProductAnalysis(sortedProducts);
    }

    function renderProductAnalysis(products) {
      // Render summary cards
      const cardsContainer = document.getElementById("productSummaryCards");
      cardsContainer.innerHTML = "";
      
      products.slice(0, 6).forEach(product => {
        const card = document.createElement("div");
        card.className = "product-card";
        card.innerHTML = `
          <h4>Produto</h4>
          <div class="product-name">${product.productName}</div>
          <div class="quantity">${product.totalQuantity}</div>
          <div class="value">R$ ${product.totalValue.toFixed(2).replace('.', ',')}</div>
          <small>${product.salesCount} venda(s)</small>
        `;
        cardsContainer.appendChild(card);
      });
      
      // Render detailed table
      const tbody = document.getElementById("productDetailsTableBody");
      tbody.innerHTML = "";
      
      products.forEach((product, index) => {
        // Main product row
        const row = document.createElement("tr");
        row.className = "product-row";
        row.innerHTML = `
          <td>
            <button class="expand-btn" onclick="toggleProductDetails(${index})">
              <span id="expand-icon-${index}">▶</span> ${product.productName}
            </button>
          </td>
          <td>${product.totalQuantity}</td>
          <td>R$ ${product.averageUnitValue.toFixed(2).replace('.', ',')}</td>
          <td class="receipt-value">R$ ${product.totalValue.toFixed(2).replace('.', ',')}</td>
          <td>${product.salesCount}</td>
        `;
        tbody.appendChild(row);
        
        // Details row (hidden by default)
        const detailsRow = document.createElement("tr");
        detailsRow.className = "sales-details";
        detailsRow.id = `details-${index}`;
        
        let salesHtml = product.sales.map(sale => `
          <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 5px;">
            <strong>Data:</strong> ${new Date(sale.date).toLocaleDateString('pt-BR')} | 
            <strong>Comprador:</strong> ${sale.buyer} | 
            <strong>Qtd:</strong> ${sale.quantity} | 
            <strong>Valor Unit.:</strong> R$ ${sale.unitValue.toFixed(2).replace('.', ',')} | 
            <strong>Total:</strong> R$ ${sale.totalValue.toFixed(2).replace('.', ',')}
          </div>
        `).join('');
        
        detailsRow.innerHTML = `
          <td colspan="5">
            <div style="padding: 10px;">
              <h4>Detalhes das Vendas:</h4>
              ${salesHtml}
            </div>
          </td>
        `;
        tbody.appendChild(detailsRow);
      });
    }

    function toggleProductDetails(index) {
      const detailsRow = document.getElementById(`details-${index}`);
      const icon = document.getElementById(`expand-icon-${index}`);
      
      if (detailsRow.classList.contains('show')) {
        detailsRow.classList.remove('show');
        icon.textContent = '▶';
      } else {
        detailsRow.classList.add('show');
        icon.textContent = '▼';
      }
    }

    function exportProductAnalysisToPDF() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      
      updateProductAnalysis(); // Ensure we have current data
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Cabeçalho
        doc.setFontSize(18);
        doc.text("Análise de Vendas por Produto - Rodeio Agronegócio", 105, 20, { align: "center" });
        
        // Período
        let periodo = "Período: ";
        if (startDate && endDate) {
          periodo += `${new Date(startDate).toLocaleDateString('pt-BR')} a ${new Date(endDate).toLocaleDateString('pt-BR')}`;
        } else if (startDate) {
          periodo += `A partir de ${new Date(startDate).toLocaleDateString('pt-BR')}`;
        } else if (endDate) {
          periodo += `Até ${new Date(endDate).toLocaleDateString('pt-BR')}`;
        } else {
          periodo += "Todos os registros";
        }
        
        doc.setFontSize(12);
        doc.text(periodo, 105, 30, { align: "center" });
        
        // Preparar dados para tabela
        const sortBy = document.getElementById("sortBy").value;
        let sortedProducts = [...productAnalysisData];
        
        switch (sortBy) {
          case 'quantity':
            sortedProducts.sort((a, b) => b.totalQuantity - a.totalQuantity);
            break;
          case 'value':
            sortedProducts.sort((a, b) => b.totalValue - a.totalValue);
            break;
          case 'name':
            sortedProducts.sort((a, b) => a.productName.localeCompare(b.productName));
            break;
          case 'sales':
            sortedProducts.sort((a, b) => b.salesCount - a.salesCount);
            break;
        }
        
        const tableData = sortedProducts.map(product => [
          product.productName,
          product.totalQuantity.toString(),
          `R$ ${product.averageUnitValue.toFixed(2).replace('.', ',')}`,
          `R$ ${product.totalValue.toFixed(2).replace('.', ',')}`,
          product.salesCount.toString()
        ]);
        
        doc.autoTable({
          head: [['Produto', 'Qtd Total', 'Valor Médio', 'Valor Total', 'Nº Vendas']],
          body: tableData,
          startY: 45,
          theme: 'grid',
          styles: { fontSize: 10 },
          headStyles: { fillColor: [44, 85, 48] }
        });
        
        // Salvar
        const fileName = `Analise_Produtos_${new Date().toISOString().slice(0,10)}.pdf`;
        doc.save(fileName);
        
      } catch (error) {
        console.error("Erro ao exportar PDF:", error);
        alert("Erro ao exportar PDF. Verifique se as bibliotecas estão carregadas.");
      }
    }

    function applyFilters() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const buyerFilter = document.getElementById("buyerFilter").value.toLowerCase();
      
      let filteredData = receiptsData;
      
      // Filtrar por data
      if (startDate) {
        filteredData = filteredData.filter(receipt => receipt.date >= startDate);
      }
      
      if (endDate) {
        filteredData = filteredData.filter(receipt => receipt.date <= endDate);
      }
      
      // Filtrar por comprador
      if (buyerFilter) {
        filteredData = filteredData.filter(receipt => 
          receipt.soldTo.toLowerCase().includes(buyerFilter)
        );
      }
      
      updateSummary(filteredData);
      renderReceiptsTable(filteredData);
    }

    function updateSummary(data) {
      const totalReceipts = data.length;
      const totalValue = data.reduce((sum, receipt) => sum + (receipt.totalValue || 0), 0);
      const totalQuantity = data.reduce((sum, receipt) => sum + (receipt.exitQuantity || 0), 0);
      
      document.getElementById("totalReceipts").textContent = totalReceipts;
      document.getElementById("totalValue").textContent = `R$ ${totalValue.toFixed(2).replace('.', ',')}`;
      document.getElementById("totalQuantity").textContent = totalQuantity;
    }

    function renderReceiptsTable(data) {
      const tbody = document.getElementById("receiptsTableBody");
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">Nenhum recibo encontrado para os filtros aplicados</td></tr>';
        return;
      }
      
      tbody.innerHTML = data.map(receipt => `
        <tr>
          <td>${new Date(receipt.date).toLocaleDateString('pt-BR')}</td>
          <td>${receipt.soldTo}</td>
          <td>${receipt.productName}</td>
          <td>${receipt.exitQuantity}</td>
          <td class="receipt-value">R$ ${(receipt.unitValue || 0).toFixed(2).replace('.', ',')}</td>
          <td class="receipt-value">R$ ${(receipt.totalValue || 0).toFixed(2).replace('.', ',')}</td>
          <td>${receipt.receiptNumber || 'N/A'}</td>
        </tr>
      `).join('');
    }

    function exportToPDF() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const buyerFilter = document.getElementById("buyerFilter").value;
      
      // Aplicar filtros atuais
      let filteredData = receiptsData;
      
      if (startDate) {
        filteredData = filteredData.filter(receipt => receipt.date >= startDate);
      }
      
      if (endDate) {
        filteredData = filteredData.filter(receipt => receipt.date <= endDate);
      }
      
      if (buyerFilter) {
        filteredData = filteredData.filter(receipt => 
          receipt.soldTo.toLowerCase().includes(buyerFilter.toLowerCase())
        );
      }
      
      if (filteredData.length === 0) {
        alert("Nenhum dado para exportar com os filtros aplicados.");
        return;
      }
      
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Cabeçalho
        doc.setFontSize(18);
        doc.text("Relatório de Vendas - Rodeio Agronegócio", 105, 20, { align: "center" });
        
        // Período
        let periodo = "Período: ";
        if (startDate && endDate) {
          periodo += `${new Date(startDate).toLocaleDateString('pt-BR')} a ${new Date(endDate).toLocaleDateString('pt-BR')}`;
        } else if (startDate) {
          periodo += `A partir de ${new Date(startDate).toLocaleDateString('pt-BR')}`;
        } else if (endDate) {
          periodo += `Até ${new Date(endDate).toLocaleDateString('pt-BR')}`;
        } else {
          periodo += "Todos os registros";
        }
        
        doc.setFontSize(12);
        doc.text(periodo, 105, 30, { align: "center" });
        
        // Resumo
        const totalReceipts = filteredData.length;
        const totalValue = filteredData.reduce((sum, receipt) => sum + (receipt.totalValue || 0), 0);
        const totalQuantity = filteredData.reduce((sum, receipt) => sum + (receipt.exitQuantity || 0), 0);
        
        doc.text(`Total de Recibos: ${totalReceipts}`, 20, 45);
        doc.text(`Valor Total: R$ ${totalValue.toFixed(2).replace('.', ',')}`, 20, 52);
        doc.text(`Quantidade Total: ${totalQuantity}`, 20, 59);
        
        // Tabela
        const tableData = filteredData.map(receipt => [
          new Date(receipt.date).toLocaleDateString('pt-BR'),
          receipt.soldTo,
          receipt.productName,
          receipt.exitQuantity.toString(),
          `R$ ${(receipt.unitValue || 0).toFixed(2).replace('.', ',')}`,
          `R$ ${(receipt.totalValue || 0).toFixed(2).replace('.', ',')}`
        ]);
        
        doc.autoTable({
          head: [['Data', 'Comprador', 'Produto', 'Qtd', 'Valor Unit.', 'Valor Total']],
          body: tableData,
          startY: 70,
          theme: 'grid',
          styles: { fontSize: 8 },
          headStyles: { fillColor: [44, 85, 48] }
        });
        
        // Salvar
        const fileName = `Relatorio_Vendas_${new Date().toISOString().slice(0,10)}.pdf`;
        doc.save(fileName);
        
      } catch (error) {
        console.error("Erro ao exportar PDF:", error);
        alert("Erro ao exportar PDF. Verifique se as bibliotecas estão carregadas.");
      }
    }

    // Tornar funções globais
    window.loadReceiptsData = loadReceiptsData;
    window.applyFilters = applyFilters;
    window.exportToPDF = exportToPDF;
    window.toggleProductDetails = toggleProductDetails;
    window.exportProductAnalysisToPDF = exportProductAnalysisToPDF;
  </script>

  <header>
    <div class="logo-container">
        <img src="img/Sem título(1).png" alt="Logo Rodeio Agronegócio" class="logo">
    </div>
    <nav>
        <ul class="navbar">
            <li><a href="index.html"><span class="material-icons">person_add</span>Cadastro</a></li>
            <li><a href="cliente.html"><i class="fi fi-ss-member-list"></i>Geral</a></li>
            <li><a href="consolidado.html"><span class="material-icons">trending_up</span> Relatório</a></li>
            <li><a href="relatorio-vendas.html" class="active"><span class="material-icons">receipt</span>Vendas</a></li>
        </ul>
    </nav>
    <div class="header-spacer"></div>
  </header>

  <div class="sales-report-container">
    <div class="report-header">
      <h1>Relatório de Vendas</h1>
      <p>Controle completo de recibos e análise de produtos</p>
    </div>

    <div class="analysis-tabs">
      <button id="receiptsTab" class="tab-button active"><span class="material-icons">receipt_long</span> Lista de Recibos</button>
      <button id="productsTab" class="tab-button"><span class="material-icons">analytics</span> Análise por Produto</button>
    </div>

    <div class="filters-section">
      <h3>Filtros</h3>
      <div class="filters-row">
        <div class="filter-group">
          <label for="startDate">Data Inicial:</label>
          <input type="date" id="startDate">
        </div>
        <div class="filter-group">
          <label for="endDate">Data Final:</label>
          <input type="date" id="endDate">
        </div>
        <div class="filter-group">
          <label for="buyerFilter">Comprador:</label>
          <input type="text" id="buyerFilter" placeholder="Nome do comprador">
        </div>
        <div class="filter-group">
          <button id="filterBtn" class="filter-btn">Aplicar Filtros</button>
        </div>
      </div>
    </div>

    <!-- Tab Content: Receipts -->
    <div id="receiptsContent" class="tab-content active">
      <div class="summary-cards">
        <div class="summary-card">
          <h3>Total de Recibos</h3>
          <p class="value" id="totalReceipts">0</p>
        </div>
        <div class="summary-card">
          <h3>Valor Total</h3>
          <p class="value" id="totalValue">R$ 0,00</p>
        </div>
        <div class="summary-card">
          <h3>Quantidade Total</h3>
          <p class="value" id="totalQuantity">0</p>
        </div>
      </div>

      <div class="receipts-table-container">
        <div style="padding: 20px; text-align: right;">
          <button id="exportBtn" class="export-btn">Exportar Lista PDF</button>
        </div>
        <div id="loadingMessage" class="loading">Carregando dados...</div>
        <table class="receipts-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Comprador</th>
              <th>Produto</th>
              <th>Quantidade</th>
              <th>Valor Unitário</th>
              <th>Valor Total</th>
              <th>Nº Recibo</th>
            </tr>
          </thead>
          <tbody id="receiptsTableBody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tab Content: Product Analysis -->
    <div id="productsContent" class="tab-content">
      <div class="product-analysis-container">
        <div class="sort-controls">
          <label for="sortBy">Ordenar por:</label>
          <select id="sortBy">
            <option value="value">Maior Valor Total</option>
            <option value="quantity">Maior Quantidade</option>
            <option value="sales">Mais Vendas</option>
            <option value="name">Nome do Produto</option>
          </select>
          <button id="exportProductBtn" class="export-btn">Exportar Análise PDF</button>
        </div>
        
        <div id="productSummaryCards" class="product-summary-cards">
          <!-- Cards will be populated by JavaScript -->
        </div>
        
        <table class="product-details-table">
          <thead>
            <tr>
              <th>Produto</th>
              <th>Qtd Total</th>
              <th>Valor Médio</th>
              <th>Valor Total</th>
              <th>Nº Vendas</th>
            </tr>
          </thead>
          <tbody id="productDetailsTableBody">
            <!-- Product details will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <footer>
    <p>© 2024 Rodeio Agronegócio - Todos os direitos reservados.</p>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
